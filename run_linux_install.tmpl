#!/bin/bash -x
# http://masterminds.github.io/sprig/  template docs. 
# chezmoi  data 
{{ if eq .chezmoi.os "linux" }}

export  https_proxy=http://114.116.248.206:1091
export  http_proxy=http://114.116.248.206:1091

echo "Install and configure for Ubuntu."

export  $(grep CODENAME /etc/os-release | xargs)

# install pre package for emacs
install_emacs_pre () {
    sudo add-apt-repository ppa:git-core/ppa
    sudo apt update
    sudo apt-get install sqlite3 cargo git
    cargo install fd-find ripgrep
}

# install emacs
install_emacs () {
    sudo add-apt-repository -y ppa:kelleyk/emacs
    sudo apt-get install emacs27
    # forge need a ~/.authinfo.gpg file
}

# install pritunl
install_printul () {
    echo 'https://repo.pritunl.com/stable/apt $UBUNTU_CODENAME main' > /etc/apt/sources.list.d/pritunl.list
    
    sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com --recv 7568D9BB55FF9E5287D586017AE645C0CF8E292A
    sudo apt-get update
    sudo apt-get install pritunl-client-electron
}

# install dropbox
install_dropbox () {
    wget https://www.dropbox.com/download?dl=packages/ubuntu/dropbox_2020.03.04_amd64.deb -O /tmp/dropbox.deb
    sudo dpkg -i /tmp/dropbox.deb
    sudo apt-get install -f
    sudo dpkg -i /tmp/dropbox.deb
    dropbox start -i
    dropbox autostart
    dropbox proxy manual http localhost 1091
}


# install rofi
install_rofi () {
    echo "start to install rofi,if you under 20.10 and want latest version, Please install from build."
    sudo apt-get install rofi
    # build need many package extend in install docs.
    #   apt-get install gcc make autoconf automake pkg-config flex bison check libxkbcommon0 libxkbcommon-dev  libglib2.0-dev  xcb  texinfo
    # you should upgrade check to new under 20.10 ubuntu.
    # https://github.com/libcheck/check
}

install_trojan () {
    echo "start to install trojan"
    wget https://github.com/trojan-gfw/trojan/releases/download/v1.14.1/trojan-1.14.1-linux-amd64.tar.xz  -O /tmp/trojan.tar.xz
    sudo tar xvf /tmp/trojan.tar.gz -C /root
    sudo mv /root/trojan  /root/.trojan
    sudo cp  etc/systemd/system/trojan.service  /etc/systemd/system/
    systemctl daemon-reload
    service trojan start
} 

# setting local proxy network
install_proxy_network () {
    echo "you should install and configure trojan"
    sudo apt-get install redsocks
    sudo cp -r etc/redsocks.conf  /etc/
    sudo cp -r etc/privoxy        /etc/
    sudo service redsocks restart
    sudo service privoxy  restart
    cp   bin/proxy*  /usr/local/bin/
}

# install fzf package
install_fzf () {
    pushd ~/.fzf
    make
    sudo make install
    ./install
    sudo apt-get install highlight
    popd
}

chmod +x ~/.emacs.d/bin/doom
~/.emacs.d/bin/doom  sync

dpkg -l       |grep sqlite3                       || install_emacs_pre
dpkg -l       |grep emacs27                       || install_emacs
dpkg -l       |grep pritunl-client-electron       || install_pritunl
which dropbox                                     || install_dropbox
dpkg -l       |grep rofi                          || install_rofi
find /root/.trojan -name "trojan" -type d         || install_trojan
netstat -apn  |grep 1091                          || install_proxy_network

{{ end }}




